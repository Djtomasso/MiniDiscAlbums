<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MiniDisc Collection</title>
  <meta name="theme-color" content="#0a0a0a" />
  <!-- voorkomt favicon.ico 404 (optioneel) -->
  <link rel="icon" href="data:,">

  <style>
    :root{
      --bg:#0a0a0a; --surface:#121212; --surface2:#151515;
      --text:#f5f5f5; --muted:#c7c7c7; --border:#2a2a2a; --focus:#fff
    }
    *{box-sizing:border-box}
    html{scrollbar-gutter:stable both-edges}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    a{color:inherit}
    .wrap{max-width:1100px;margin:auto;padding:16px;display:grid;gap:16px}
    header{display:grid;gap:8px}
    h1{margin:0;font-size:1.5rem}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .search{flex:1;display:flex;gap:8px}
    .search input{
      flex:1;background:#0e0e0e;border:1px solid var(--border);color:var(--text);
      padding:10px;border-radius:10px
    }
    .search button{
      background:#151515;color:var(--text);border:1px solid var(--border);
      border-radius:10px;padding:10px 12px;cursor:pointer
    }
    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    @media(min-width:680px){ .grid{ grid-template-columns:repeat(3,1fr)} }
    @media(min-width:980px){ .grid{ grid-template-columns:repeat(4,1fr)} }
    .card{
      border:1px solid var(--border);background:var(--surface);
      border-radius:14px;overflow:hidden;display:grid;grid-template-rows:auto 1fr
    }
    /* Vierkante thumbnails */
    .cover{aspect-ratio:1/1;background:#0c0c0c}
    .cover img{width:100%;height:100%;object-fit:cover;display:block}
    .meta{padding:10px;display:grid;gap:8px}
    .title{font-weight:600;line-height:1.25}
    .btn{
      display:inline-block;text-decoration:none;padding:8px 10px;border-radius:8px;
      border:1px solid var(--border);background:#191919;justify-self:start
    }
    .empty, .error{color:var(--muted);text-align:center;padding:20px;border:1px dashed var(--border);border-radius:12px}
    footer{color:var(--muted);font-size:.9rem;text-align:center;padding:10px}

    /* Scroll-to-top button (centered) */
    #scrollTopBtn{
      position: fixed;
      left: 50%;
      bottom: 22px;
      transform: translateX(-50%);
      width: 58px;
      height: 58px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: #151515;
      color: var(--text);
      font-size: 26px;
      line-height: 1;
      cursor: pointer;
      display: none;            /* wordt via JS getoond */
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: transform .25s ease, background .25s ease;
    }
    #scrollTopBtn:hover{
      background: #1d1d1d;
      transform: translateX(-50%) translateY(-2px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Minidisc Album Collection</h1>
      <div class="bar">
        <div class="search">
          <input id="q" type="search" placeholder="Zoek op album, artiest of song…" aria-label="Zoek albums">
          <button id="clear" type="button">Wissen</button>
        </div>
      </div>
    </header>

    <section id="content">
      <div id="status" class="empty">Laden…</div>
      <div id="albums" class="grid" hidden></div>
    </section>

    <footer>overzicht door Tomasso 2025</footer>
  </div>

  <!-- Scroll-to-top button (moet boven het script staan) -->
  <button id="scrollTopBtn" aria-label="Scroll naar boven">↑</button>

  <script>
    const TRACKS_URL = '/MiniDiscAlbums/tracks_index.json';
    const MANIFEST_URL = '/MiniDiscAlbums/albums.json';
    const PLACEHOLDER = '/MiniDiscAlbums/image/placeholder.png';

    // --- Track index lazy-load + cache ---
    const TRACKS_CACHE_KEY = 'md_tracks_index_cache_v1';
    const TRACKS_CACHE_TIME_KEY = 'md_tracks_index_cache_time_v1';
    const TRACKS_CACHE_TTL_MS = 1000 * 60 * 60 * 24 * 7; // 7 dagen

    // --- Force reset track cache on every page load ---
    try {
      localStorage.removeItem(TRACKS_CACHE_KEY);
      localStorage.removeItem(TRACKS_CACHE_TIME_KEY);
    } catch (_) {}

    function loadTracksCache(){
      try{
        const t = parseInt(localStorage.getItem(TRACKS_CACHE_TIME_KEY) || '0', 10);
        if(!t || (Date.now() - t) > TRACKS_CACHE_TTL_MS) return null;
        const raw = localStorage.getItem(TRACKS_CACHE_KEY);
        if(!raw) return null;
        const data = JSON.parse(raw);
        return (data && typeof data === 'object') ? data : null;
      }catch(_){ return null; }
    }
    function saveTracksCache(obj){
      try{
        localStorage.setItem(TRACKS_CACHE_KEY, JSON.stringify(obj));
        localStorage.setItem(TRACKS_CACHE_TIME_KEY, String(Date.now()));
      }catch(_){}
    }

    const $grid = document.getElementById('albums');
    const $status = document.getElementById('status');
    const $q = document.getElementById('q');
    const $clear = document.getElementById('clear');

    function cardTemplate(entry){
      const title = entry.title || entry.file || 'Album';
      const fileUrl = entry.file || '#';
      const cover = entry.cover || PLACEHOLDER;
      return `
        <article class="card">
          <a class="coverlink" href="${fileUrl}" aria-label="Open ${title}">
            <div class="cover">
              <img src="${cover}" alt="Cover ${title}" onerror="this.onerror=null;this.src='${PLACEHOLDER}'">
            </div>
          </a>
          <div class="meta">
            <div class="title">${title}</div>
            <!-- Serie/volume worden bewust NIET getoond -->
            <a class="btn" href="${fileUrl}">Open tracklist</a>
          </div>
        </article>`;
    }

    /* ===== Slimme sortering (gebruikt series/volume, maar toont ze niet) ===== */
    const NUMWORDS = new Map(Object.entries({
      // it
      "una":1,"uno":1,"due":2,"tre":3,"quattro":4,"cinque":5,"sei":6,"sette":7,"otto":8,"nove":9,"dieci":10,
      // en
      "one":1,"two":2,"three":3,"four":4,"five":5,"six":6,"seven":7,"eight":8,"nine":9,"ten":10,
      // nl
      "een":1,"twee":2,"drie":3,"vier":4,"vijf":5,"zes":6,"zeven":7,"acht":8,"negen":9,"tien":10,
      // es
      "uno":1,"dos":2,"tres":3,"cuatro":4,"cinco":5,"seis":6,"siete":7,"ocho":8,"nueve":9,"diez":10,
      // fr
      "un":1,"deux":2,"trois":3,"quatre":4,"cinq":5,"six":6,"sept":7,"huit":8,"neuf":9,"dix":10
    }));

    function romanToInt(s){
      if(!s) return null;
      const map = {I:1,V:5,X:10,L:50,C:100,D:500,M:1000};
      let n = 0;
      for(let i=0;i<s.length;i++){
        const v = map[s[i]], w = map[s[i+1]]||0;
        if(v < w){ n += w - v; i++; } else { n += v; }
      }
      return n || null;
    }

    function inferVolumeFromTitle(title){
      if(!title) return null;
      const t = title.toLowerCase()
        .normalize('NFD').replace(/\p{Diacritic}+/gu,''); // accenten weg
      const words = t.match(/\b[\p{L}]+|\d+\b/gu) || [];

      // 1) woordgetallen
      for(const w of words){ if(NUMWORDS.has(w)) return NUMWORDS.get(w); }
      // 2) roman numerals
      const roman = t.match(/\bM{0,3}(CM|CD|D?C{0,3})?(XC|XL|L?X{0,3})?(IX|IV|V?I{0,3})\b/i);
      if(roman && roman[0] && /[ivxlcdm]/i.test(roman[0])){
        const v = romanToInt(roman[0].toUpperCase());
        if(v) return v;
      }
      // 3) cijfers
      const digit = t.match(/\b(\d{1,3})\b/);
      if(digit) return parseInt(digit[1],10);

      return null;
    }

    function sortTuple(entry){
      const order = Number.isFinite(entry.order) ? entry.order : Infinity;
      const series = (entry.series || '').toLowerCase();
      const volume = Number.isFinite(entry.volume)
        ? entry.volume
        : (inferVolumeFromTitle(entry.title || entry.file) ?? Infinity);
      const titleKey = (entry.title || entry.file || '').toLowerCase();
      return [order, series, volume, titleKey];
    }

    function smartSort(a,b){
      const A = sortTuple(a), B = sortTuple(b);
      for(let i=0;i<A.length;i++){
        const x = A[i], y = B[i];
        if(x === y) continue;
        if(typeof x === 'string' || typeof y === 'string'){
          return String(x).localeCompare(String(y), 'nl-NL', {sensitivity:'base'});
        }
        return (x < y) ? -1 : 1;
      }
      return 0;
    }

    /* ===== Laden & tonen ===== */
    let manifest = [];
    let tracksIndex = undefined; // undefined=not loaded, null=failed, object=loaded
    let tracksLoading = false;

    async function loadManifest(){
      const res = await fetch(MANIFEST_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('albums.json niet gevonden');
      const list = await res.json();
      if(!Array.isArray(list)) throw new Error('albums.json is geen array');
      manifest = list.slice(); // kopie
    }

    async function loadTracksIndex(){
      // 1) probeer cache
      const cached = loadTracksCache();
      if(cached){
        tracksIndex = cached;
        return;
      }
      try{
        const res = await fetch(TRACKS_URL, { cache: 'no-store' });
        if(!res.ok) throw new Error('tracks_index.json niet gevonden (HTTP ' + res.status + ')');
        const txt = await res.text();
        const cleaned = txt.replace(/^\uFEFF/, '').trim(); // strip BOM + whitespace
        const data = JSON.parse(cleaned);
        tracksIndex = (data && typeof data === 'object') ? data : null;
        if(tracksIndex) saveTracksCache(tracksIndex);
      }catch(err){
        console.warn('Track-index niet geladen:', err);
        tracksIndex = null;
      }
    }

    function render(list){
      if(!list.length){
        $grid.hidden = true;
        $status.textContent = 'Geen albums gevonden.';
        $status.className = 'empty';
        return;
      }
      $grid.innerHTML = '';
      list.forEach(item => $grid.insertAdjacentHTML('beforeend', cardTemplate(item)));
      $status.textContent = '';
      $status.className = 'empty';
      $grid.hidden = false;
    }

    async function applyFilter(){
      const q = ($q.value || '').toLowerCase().trim();

      if(!q){
        render(manifest.slice().sort(smartSort));
        return;
      }

      // matches op album metadata
      const base = manifest.filter(a =>
        (a.title || '').toLowerCase().includes(q) ||
        (a.series || '').toLowerCase().includes(q)
      );

      // Voor performance: laad tracks pas bij "echte" zoekopdracht
      // (>=3 tekens) en alleen als nog niet geladen.
      if(q.length >= 3 && tracksIndex === undefined && !tracksLoading){
        tracksLoading = true;
        render(base.sort(smartSort));
        $status.textContent = 'Tracks index laden...';
        $status.className = 'empty';
        await loadTracksIndex();
        tracksLoading = false;
      }

      if(tracksIndex && q.length >= 3){
        const extra = manifest.filter(a => {
          if(base.includes(a)) return false;
          const tr = tracksIndex[a.file] || [];
          return tr.some(x =>
            (x.t || '').toLowerCase().includes(q) ||
            (x.a || '').toLowerCase().includes(q)
          );
        });
        render(base.concat(extra).sort(smartSort));
      }else{
        render(base.sort(smartSort));
      }
    }

    $q.addEventListener('input', () => applyFilter());
    $clear.addEventListener('click', () => { $q.value=''; applyFilter(); $q.focus(); });

    (async () => {
      try{
        await loadManifest();
        applyFilter(); // sorteer direct bij start
      }catch(err){
        $status.textContent = 'Kon data niet laden. Open de console (F12) voor details.';
        $status.className = 'error';
        console.error(err);
      }
    })();

    // ===== Scroll-to-top button logic (robust) =====
    (function () {
      const btn = document.getElementById('scrollTopBtn');
      if (!btn) return; // geen errors als knop ontbreekt

      function updateBtn() {
        const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
        const docHeight = (document.documentElement.scrollHeight || 0) - window.innerHeight;

        // Toon na 1/3 van de scrollbare hoogte
        if (docHeight > 0 && scrollY > docHeight / 4) {
          btn.style.display = 'flex';
        } else {
          btn.style.display = 'none';
        }
      }

      window.addEventListener('scroll', updateBtn, { passive: true });
      window.addEventListener('resize', updateBtn);

      btn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      updateBtn(); // initieel
    })();
  </script>
</body>
</html>
